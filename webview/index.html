<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      background: transparent;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: system-ui, sans-serif;
      position: relative;
    }

    img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      image-rendering: -webkit-optimize-contrast;
      z-index: 1;
      background: transparent;
    }

    h2 {
      font-size: 13px;
      font-weight: 600;
      margin: 4px 0 8px;
      text-align: center;
    }

    canvas {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }

    .wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      width: 100vw;
      height: 100vh;
    }
  </style>
  <title>Welcome Home Hakuji</title>
</head>

<body>
  <div class="wrap">
    <img src="{{IMG_SRC}}" alt="Welcome Home Hakuji ðŸŽ†"
      style="max-width: 100%; max-height: 100%; margin: auto; display: block; position: relative; z-index: 1;" />
    <canvas id="snow"
      style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;"></canvas>
  </div>
  <script>
    const canvas = document.getElementById('snow')
    const ctx = canvas.getContext('2d')
    let W = 0
    let H = 0

    function resize() {
      W = canvas.width = canvas.clientWidth = window.innerWidth
      H = canvas.height = canvas.clientHeight = window.innerHeight
    }
    window.addEventListener('resize', resize)
    resize()

    // Snowflake state
    let typingDriven = false
    let typingRate = 0
    let density = 80
    let snowColor = 'rgba(180,220,255,' // default fallback
    let baseSpeed = 0.7

    const flakes = []
    function spawnFlake(override = {}) {
      // override: {speed, y}
      const v = override.speed ? override.speed : (baseSpeed + Math.random() * 1.2)
      const y = override.y ? override.y : (-10 - Math.random() * 40)
      return {
        x: Math.random() * W,               // Horizontal position (random across canvas width)
        y,                                  // Vertical position (usually above the visible area)
        r: 15 + Math.random() * 8,          // Radius (size) of the snowflake, 15-23px
        v,                                  // Vertical speed (fall speed)
        a: 0.5 + Math.random() * 0.5,       // Alpha (opacity) for gradient, 0.5-1.0
        phase: Math.random() * Math.PI * 2, // Initial phase for horizontal drift
        drift: 0.3 + Math.random() * 0.7    // Amplitude of horizontal drift (sway)
      }
    }

    function ensureFlakes() {
      while (flakes.length < density) flakes.push(spawnFlake())
      if (flakes.length > density) flakes.splice(density)
    }

    function tick() {
      if (!typingDriven) ensureFlakes()
      ctx.clearRect(0, 0, W, H)
      ctx.globalCompositeOperation = 'lighter'
      for (const f of flakes) {
        f.y += f.v
        f.x += Math.sin(f.phase) * f.drift
        f.phase += 0.01 + Math.random() * 0.02
        if (f.y - f.r > H) { f.y = -f.r; f.x = Math.random() * W }
        if (f.x < -20) f.x = W + 20; else if (f.x > W + 20) f.x = -20
        // Use configured color
        const colorA = snowColor.endsWith(',') ? `${snowColor}${0.9 * f.a})` : snowColor
        const colorB = snowColor.endsWith(',') ? `${snowColor}0)` : snowColor
        const grd = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, f.r)
        grd.addColorStop(0, colorA)
        grd.addColorStop(1, colorB)
        ctx.fillStyle = grd
        ctx.beginPath()
        ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2)
        ctx.fill()
      }
      requestAnimationFrame(tick)
    }
    tick()

    // Listen for extension messages
    window.addEventListener('message', event => {
      const msg = event.data
      if (!msg) {
        console.error('Received empty message')
        return
      }
      if (!msg.type) {
        console.error('Message missing type', msg)
        return
      }
      if (msg.type === 'CONFIG') {
        typingDriven = msg.typingDriven
        density = msg.density
        snowColor = msg.color
        baseSpeed = msg.speed
        // Reset flakes for normal snow
        if (!typingDriven) flakes.length = 0
        return
      }
      if (msg.type === 'KEY' && typingDriven) {
        typingRate = msg.typingRate
        // Spawn a flake per keypress, speed based on typing rate
        const speed = baseSpeed + typingRate
        flakes.push(spawnFlake({ speed, y: -10 }))
        if (flakes.length > density) flakes.splice(0, flakes.length - density)
      }
    })
  </script>
</body>

</html>